---
title: November 15
description: Daily for November 15, 2025
hero:
  # tagline: Андрей Соболев
  image: 
    file: ../../../../../assets/heros/hero002.png    
---
import { Image } from "astro:assets";

Так как я лишён доступа к Github Copilot на текущий момент, но я думаю найду вариант, как им нормально продолжить пользоваться, я начал перебирать доступные варианты из доступных. Я конечно понимаю что все что не локально, скоро будет стоит космических денег, так как почти все ИИ доступные на рынке как бизнес достаточно убыточны, чтобы они не говорили в обратную сторону, и пока идет хайп можно пользовать модели с огромными требованиями по памяти, за достаточно небольшие деньги.

Что доступно сейчас, не так много но и не мало, остановился на моделях доступных для использования в режиме чата, с минимальной регистраций, и даже без смс :-)

Взял и пробую https://chat.z.ai + локально запускаю gpt-oss-20b, хотелось бы 120b но пока ресурсы не позволяют, нужно минимум 128GB унифицированной памяти, но не беда когда нибудь может и до такого дорасту. Нужно еще попробовать будет Kimi K2.

Так что я несколько дней, по немного, занимался адаптацией сервиса аккаунтов к чистому PostgreSQL, у нас были заточки на CockroachDB, на часть его типов, часть функций, но нужно уметь еще и на оригинальном PostgreSQL работать, а то не гоже.

На текущий момент, сделал PR, осталось понять работает или нет, жду как будут идти тесты, если не где не накосячил. Чинить явно уже буду не сегодня.

Перебирал в начале в ручную, но там совсем не тривиально, в итоге через несколько десятков итераций, удалось получить решение, которое вроде бы работает в обоих базах, не сильно меняет весь код. Но кое что конечно пришлось перетрясти.

К вопросу не тривиальности, исторически там накопилось уже 21 миграция SQL туда, сюда обратно, и выкинуть ее так просто не получиться, хотя хотелось бы, так что добавил идентификацию базы данных, и вперед. И сам файлик с миграциями 711 строчек однако. Были мысли взять какой нить Drizzly, но что то подумал что сейчас это не так важно, более важно заставить работать и пока отложить эту тему.

Из самого интересно несовместимости по типам что были, пришлось сгородить такую структуру:

```typescript
const dbTypes = {
  ['cockroach' as DBFlavor]: {
    string: 'STRING',
    bytes: 'BYTES',
    int2: 'INT2',
    int4: 'INT4',
    int8: 'INT8',
    bool: 'BOOL',
    // unique_rowid() generates a unique INT8
    autoIncrementInt8: (ns: string) => 'INT8 NOT NULL DEFAULT unique_rowid()'
  },
  ['postgres' as DBFlavor]: {
    string: 'TEXT',
    bytes: 'BYTEA',
    int2: 'SMALLINT',
    int4: 'INTEGER',
    int8: 'BIGINT',
    bool: 'BOOLEAN',
    // Use special function to generate a cryptographic random bigint
    autoIncrementInt8: (ns: string) => `BIGINT NOT NULL DEFAULT ${ns}.gen_random_bigint()`
  }
}
```

Тут самое интересное `gen_random_bigint()` которую пришлось добавить, через модуль `pgcrypto` который просто так не доступен, и нужно добавлять через `CREATE EXTENSION IF NOT EXISTS pgcrypto;`. Столько новых слов узнал за сегодня :-)

Сама функция тоже интересна:

```typescript
 CREATE OR REPLACE FUNCTION ${ns}.gen_random_bigint()
    RETURNS BIGINT AS $$             
      SELECT ('x' || encode(gen_random_bytes(8), 'hex'))::bit(64)::bigint & 9223372036854775807::bigint;
    $$ LANGUAGE SQL VOLATILE;
```

Выносит мозг только так. Если есть эксперты в SQL, подскажите может можно проще. Нашел еще в 18 есть тип BIGSERIAL, но он последовательные номера дает, а это сможет позволить делать перебор, что не хотелось бы. На текущий момент для social id это может быть и не важно, но для invite id вполне может быть очень даже и важно.

Раньше у нас было `unique_rowid()` а в PostgreSQL такого нету, но написал небольшой тест, вроде работает примерно также, + аккаунты и social id не настолько частые операции чтобы переживать, ну если будут рандомы повторяться, и вылазить ошибки уже надо будет какую то синхронизацию сделать.

Как пройдут тесты буду смотреть где еще что отломано, чтобы работало как надо :-)

Остальное уже дальше.
